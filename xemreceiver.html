<!doctype html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
	<link rel="apple-touch-icon" href="icon.png">
	<title>XEMReceiver</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
	<link rel="stylesheet" href="style.css" />
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-100421513-1', 'auto');
	ga('send', 'pageview');
	</script>
</head>
<body>
	<h1>XEMReceiver</h1>
	<hr class="zigzag-orange-white">
<div class="container">
	<div class="row">
		<div class="account col-sm-4">
		<h2>アカウント</h2>
		<dl id="account_info">
			<dt>アドレス</dt><dd><span id="account_address"></span> <a target="_blank" id="account_explorer">explorer</a></dd>
			<dt>残高</dt><dd><span id="account_balance"></span> XYM</dd>
			<dt>時価総額</dt><dd><span id="market_price"></span></dd>
			<dt>重要度</dt><dd><span id="account_importance"></span></dd>
		</dl>
		<dl id="account_append_info"></dl>
		<h2>取引所</h2>
		<small>最終更新　<span id="last_update"></span></small>
		<dl>
		<dt>Gate.io</dt><dd><span id="gateio"></span></dd>
		<dt>KuCoin</dt><dd><span id="kucoin"></span></dd>
		<dt>HBTC</dt><dd><span id="hbtc"></span></dd>
		<dt>ProBit</dt><dd><span id="probit"></span></dd>
		</dl>
		<h2>ノード</h2>
		<dl id="node_info">
			<dt>接続ノード</dt><dd><span id="node_activity"></span><span id="node_host"></span></dd>
			<dt>最新ブロック</dt><dd><span id="chain_height"></span></dd>
			<dt>確定ブロック</dt><dd><span id="finalized_chain_height"></span></dd>
			<dt><a id="set_delegated_node" href="javascript:void(0)">委任ノード設定</a></dt><dd><span id="delegated_node"></span></dd>
			<dt>手数料相場</dt>
			<dd>
			<table id="fees"  class="table">
				<thead><tr>
					<th>送金[中央値]</th>
					<th>ネームスペース[年]</th>
					<th>モザイク</th>
				</tr></thead>
				<tbody><tr>
					<td><span id="fee_median"></span>XYM</td>
					<td><span id="fee_namespace"></span>XYM</td>
					<td><span id="fee_mosaic"></span>XYM</td>
				</tr></tbody>
			</table>
			</dd>

		</dl>
		</div>
		<div class="account col-sm-4">
			<h2>レシート</h2>
			<h5>対象アカウント</h5>
			<table id="harvest"  class="table">
				<thead><tr>
					<th>日時</th>
					<th>区分</th>
					<th>数量</th>
				</tr></thead>
			</table>
			<dl>
				<dd id="harvests_footer"><a id="harvests_more" href="javascript:void(0)" >さらに読み込む</a></dd>
			</dl>
			<h5>送信元アカウント</h5>
			<table id="receipt"  class="table">
				<thead><tr>
					<th>日時</th>
					<th>区分</th>
					<th>数量</th>
				</tr></thead>
			</table>
			<dl>
				<dd id="receipts_footer"><a id="receipts_more" href="javascript:void(0)" >さらに読み込む</a></dd>
			</dl>
		</div>
		<div class="account col-sm-4">
			<h2>トランザクション</h2>
			<table id="table"  class="table">
				<thead><tr>
					<th>日時</th>
					<th>区分</th>
					<th>数量</th>
				</tr></thead>
			</table>
			<dl>
				<dd id="transfers_footer"><a id="transfers_more" href="javascript:void(0)" >さらに読み込む</a></dd>
			</dl>
		</div>
	</div>
	<div>
		<div class="faucet">
			<h2>リンク</h2>
			<dl>
				<dd><a id="xemmessage"  href="">XEMMessage</a></dd>
				<dd><a id="xemtax" href="">XEMTax</a></dd>
			</dl>
		</div>
	</div>

</div>

<!-- 通知モーダル -->
<div class="modal fade" id="modal-notice" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel2">お知らせ</h5>
			</div>
			<div class="modal-body">
				<label id="modal-label">未承認のトランザクションがあります。<br>ウォレットで詳細を確認してください。</label>

				<dl id="tx_info"></dl>

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-dismiss="modal"	id="modal_ok">閉じる</button>

			</div><!-- /.modal-footer -->
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src="symbol-sdk-1.0.0.min.js"></script>
<script src="xembook_config.js"></script>
<script src="xembook.js"></script>
<script>

function showInfo(accountInfo){

	$("#node_activity").html("<font color='green'>● </font>");

}

function showAmountInfo(amount){}

function showAccountInfo(accountInfo){
}


function dispBlockTimeStamp(id,height){

	blockRepo.getBlockByHeight(height)
	.subscribe(block => {

		$(id).text(
			dispTimeStamp(Number(block.timestamp.toString()),epochAdjustment)
		);
	})
}

function appendAggTx(tx){

}

function appendTx(insTag,id,tx){

}

function insertTxAfter(insTag,id,tx){

}

function showReceiptInfo(tag,height,receipt,cnt){

}

function showTxAmountInfo(id,amount,fee){

}

var lastBlockHash = "";
setInterval(function(){

	showPriceInfo(accountRepo.getAccountInfo(address));

	var nodeActivity = "";
	if(lastBlockHash === newBlockHash){
		nodeActivity = "<font color='red'>● </font>";
	}else{
		nodeActivity = "<font color='green'>● </font>";
	}

	$("#node_activity").html(nodeActivity);
	lastBlockHash = newBlockHash;

}, 60000);

var lastHeight = 0;
var lastFinalizedHeight = 0;
function getNewInfo(block){

	t3 = dispTimeStamp(block.timestamp.compact(),epochAdjustment)
	console.log("ブロック生成日時");
	console.log(t3);


	const height = block.height;
	chainRepo.getChainInfo().subscribe(chain=>{



		//次回ファイナライズ予定
		remainHeight = 36  - (height.compact() - chain.latestFinalizedBlock.height.compact());
		t = dispTimeStamp(block.timestamp.compact() + (remainHeight * 30000),epochAdjustment)
		console.log("次回ファイナライズ発生日時");
		console.log(t);
		console.log(remainHeight);







		blockRepo.getBlockByHeight(chain.latestFinalizedBlock.height)
		.subscribe(finalizedBlock=>{
//			console.log(block.height.compact());


			t2 = dispTimeStamp(finalizedBlock.timestamp.compact(),epochAdjustment)
			console.log("現在ファイナライズ済み日時[確定]");
			console.log("[" + finalizedBlock.height.toString() + "]:" + t2);

			t2 = dispTimeStamp(finalizedBlock.timestamp.compact() + (18 * 30000),epochAdjustment)
			console.log("次回ファイナライズ対象日時");
			console.log(t2 + "までのトランザクションがファイナライズされます。");



			if(lastFinalizedHeight === 0 || lastFinalizedHeight  !== chain.latestFinalizedBlock.height.compact() ){
				console.log("update finalize!!");
				dispTimeStamp(Number(finalizedBlock.timestamp.toString()),epochAdjustment)
				lastFinalizedHeight = chain.latestFinalizedBlock.height.compact();
			}

		})
	});


	if(lastHeight !== 0 && lastHeight + 1 !== height.compact() ){

		console.log(block.height.compact());
		blockRepo.getBlockByHeight(height)
		.subscribe(block=>{
			alert("ロールバックが発生しました");
			console.log("roll back!!");
			dispTimeStamp(Number(block.timestamp.toString()),epochAdjustment)
		})


	}
	lastHeight = height.compact();
	console.log(height);

}

$("#xemmessage").attr("href", "xemmessage.html?address=" + rawAddress);
$("#xemtax"    ).attr("href", "xemtax.html?address=" + rawAddress);

</script>
</body>
</html>
