<!doctype html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
	<link rel="apple-touch-icon" href="icon.png">
	<title>XEMBook</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
	<link rel="stylesheet" href="style.css" />
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-100421513-1', 'auto');
	ga('send', 'pageview');
	</script>
</head>
<body>
<div class="container">
	<div class="account col-sm-4">
	<h2>アカウント</h2>
	<dl id="account_info">
		<dt>口座名</dt><dd><span id="account_address"></span></dd>
		<dt>残高</dt><dd><span id="account_balance"></span></dd>
		<dt>重要度</dt><dd><span id="account_importance"></span></dd>
	</dl>
	<h2>取引所</h2>
	<h2>接続ノード</h2>
	<dl id="node_info">
		<dt>ノード</dt><dd><p><span id="node_host"></span></p></dd>
		<dt>最新ブロック</dt><dd><span id="chain_height"></span></dd>
	</dl>
	</div>
	<div class="account col-sm-4">
	<h2>レシート</h2>
	<dl>
	<dt>受信</dt>
	<table id="harvest"  class="table">
		<thead><tr>
			<th>日時</th>
			<th>区分</th>
			<th>数量</th>
		</tr></thead>
	</table>
	<dd id="harvests_footer"><a id="harvests_more" href="javascript:void(0)" >さらに読み込む</a></dd>
	</dl>
	<dl>
	<dt>送信</dt>
	<table id="receipt"  class="table">
		<thead><tr>
			<th>日時</th>
			<th>区分</th>
			<th>数量</th>
		</tr></thead>
	</table>
	<dd id="receipts_footer"><a id="receipts_more" href="javascript:void(0)" >さらに読み込む</a></dd>
	</dl>
	</div>
	<div class="account col-sm-4">
	<h2>トランザクション</h2>
	<table id="table"  class="table">
		<thead><tr>
			<th>日時</th>
			<th>区分</th>
			<th>数量</th>
		</tr></thead>
	</table>
	<dd id="transfers_footer"><a id="transfers_more" href="javascript:void(0)" >さらに読み込む</a></dd>
	</div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src="symbol-sdk-0.23.3.min.js"></script>
<script>
var transferPageNumber = 0;
var harvestPageNumber = 0;
var reciptPageNumber = 0;
var address = "";
if (1 < document.location.search.length) {

	var query = document.location.search.substring(1);
	var prms = query.split('&');
	var item = new Object();
	for (var i = 0; i < prms.length; i++) {
		var elm   = prms[i].split('=');
		var idx   = decodeURIComponent(elm[0]);
		var val   = decodeURIComponent(elm[1]);
		item[idx] = decodeURIComponent(val);
	}
	address = item["address"];
}

if( address == ""){

	var proaddress = window.prompt('NEMアドレスを入力してください','');
	if(proaddress === ''){

	}else if(proaddress === null){
		alert("サンプルアカウントを表示します");
		address = "TB2E674ZMZS4XK7VPEISTZ7YVYQ2WZCWLYLNDPA";
	}else{

		proaddress = proaddress.replace( /-/g , "" ).toUpperCase();
		location.href = "https://xembook.github.io/xembook/alpha.html?address=" + proaddress;
	}
	address = address.replace( /-/g , "" ).toUpperCase();

	if(history.replaceState) {
		history.replaceState(null,null,"/?address=" + address)
	}
}
address = address.replace( /-/g , "" ).toUpperCase();

const nem = require("/node_modules/symbol-sdk");
const op = require("/node_modules/rxjs/operators");
const rxjs = require("/node_modules/rxjs");

NODES = [
	"https://sym-test.opening-line.jp:3001",
	"https://ik1-426-45408.vs.sakura.ne.jp:3001"
];

function connectNode(nodes,d){

	targetNode = nodes[Math.floor(Math.random() * nodes.length)] ;
	$.ajax({url:  targetNode + "/node/health" ,type: 'GET',timeout: 500})
	.then(res => {
		console.log(res);
		if(res.status.apiNode == "up" && res.status.db == "up"){
			return d.resolve(targetNode);
		}
		return connectNode(nodes,d);
	})
	.catch(res =>connectNode(nodes,d));
	return d.promise();
}

var d = $.Deferred();
(async() =>{
	nd = await connectNode(NODES,d);
	console.log(nd)

	//repo
	repo = new nem.RepositoryFactoryHttp(nd);
	nsRepo = repo.createNamespaceRepository();
	txRepo = repo.createTransactionRepository();
	nwRepo = repo.createNetworkRepository();
	blockRepo = repo.createBlockRepository();
	receiptRepo = repo.createReceiptRepository();
	accountRepo = repo.createAccountRepository();
	nodeRepo = repo.createNodeRepository();
	tsRepo = repo.createTransactionStatusRepository();
	chainRepo = repo.createChainRepository();
	finRepo = repo.createFinalizationRepository();
	hlRepo = repo.createHashLockRepository();
	metaRepo = repo.createMetadataRepository();
	mosaicRepo = repo.createMosaicRepository();
	msigRepo = repo.createMultisigRepository();
	resAccountRepo = repo.createRestrictionAccountRepository();
	resMosaicRepo = repo.createRestrictionMosaicRepository();
	slRepo = repo.createSecretLockRepository();

	epochAdjustment = await repo.getEpochAdjustment().toPromise();
	currencyId = (await repo.getCurrencies().toPromise()).currency.mosaicId.toHex();

	currencyNamespaceId = (new nem.NamespaceId("symbol.xym")).id.toHex();
	latestBlock = (await blockRepo.search({order: nem.Order.Desc}).toPromise()).data[0]

	alice = nem.Address.createFromRawAddress(address);
	$("#account_address").text(
		alice.address.substring(0,6)
		+ "-" +alice.address.substring(6,12)
		+ "-" + alice.address.substring(12,18)
		+"..."
	);

	//アカウント情報
	var accountInfo = accountRepo.getAccountInfo(alice);

	accountInfo
	.pipe(
		op.mergeMap(_=>_.mosaics),
		op.filter(_ => _.id.toHex() === currencyId),
	)
	.subscribe(_=>{
		$("#account_balance").append("<dd>" + dispAmount(_.amount.toString(),6) + "</dd>");
	});

	accountInfo
	.subscribe(_=>{

		var account_importance = Number(_.importance.toString()) / 100000000;
		account_importance = Math.round( account_importance );
		account_importance /= 10000;

		$("#account_importance").append("<dd>" + account_importance + "</dd>");
		getTransfers();
		getHarvests();
		getRecipets();
	});

	chainRepo.getChainInfo().subscribe(x=>{

		rxjs.zip(
			blockRepo.getBlockByHeight(x.height),
			blockRepo.getBlockByHeight(x.latestFinalizedBlock.height),

		).subscribe(x => {

			$("#chain_height").html(
				dispTimeStamp(Number(x[0].timestamp.toString()),epochAdjustment)
				+ "<br> [ファイナライズ:" + dispTimeStamp(Number(x[1].timestamp.toString()),epochAdjustment)  + "]"
			);
		})
	});
	nodeRepo.getNodeInfo().subscribe(x=>{
		$("#node_host").text(
			x.host
		);
	});
})();

//トランザクション取得
function getTransfers(){

	txRepo.search({
		address:alice,
		group:nem.TransactionGroup.Confirmed,
		embedded:true,
		pageNumber:transferPageNumber,
		order:"desc"})
	.subscribe(_=>{
		transferPageNumber++;
		if(_.isLastPage){
			$('#transfers_footer').hide();
		}
		parseTx(_.data);
	});
}

//出金レシート
function getRecipets(){

	receiptRepo.searchReceipts({
		senderAddress:alice,
		pageNumber:reciptPageNumber,
		pageSize:10,
		order:"desc"
	})
	.pipe(
		op.mergeMap(_=>{
			reciptPageNumber++;
			if(_.isLastPage){
				$('#receipts_footer').hide();
			}
			return _.data;
		}),
	).subscribe(_=>{

		var receipt = _.receipts.filter(item => {
			if(item.senderAddress){
				return item.senderAddress.plain() === alice.plain();
			}
			return false;
		});
		showReceiptInfo("receipt",_.height,receipt[0]);
	});
}

//入金レシート
function getHarvests(){

	receiptRepo.searchReceipts({
		targetAddress:alice,
		pageNumber:harvestPageNumber,
		pageSize:10,
		order:"desc"
	})
	.pipe(
		op.mergeMap(_=>{
			harvestPageNumber++;
			if(_.isLastPage){
				$('#harvests_footer').hide();
			}
			return _.data
		}),
	).subscribe(_=>{

		var receipt = _.receipts.filter(item => {
			if(item.targetAddress){
				return item.targetAddress.plain() === alice.plain();
			}
			return false;
		});

		showReceiptInfo("harvest",_.height,receipt[0]);
	});
}

function showReceiptInfo(tag,height,receipt){

	$("#" + tag).append("<tr>"
	+ "<td id='" + tag + "_date" + height + receipt.type + "'></td>"
	+ "<td id='" + tag + "_type'>" + nem.ReceiptType[receipt.type] + "</td>"
	+ "<td id='" + tag + "_amount'>" + dispAmount(receipt.amount,6) + "</td>" //mosaicLabel
	+ "</tr>"
	);


	blockRepo.getBlockByHeight(height)
	.subscribe(b => {

		$("#" + tag + "_date"+ height + receipt.type).text(
			dispTimeStamp(Number(b.timestamp.toString()),epochAdjustment)
		);
	})

/*
	rxjs.zip(
		blockRepo.getBlockByHeight(height),
		rxjs.of({height:height})

	).subscribe(x => {

		$("#" + tag + "_date"+ x[1].height).text(
			dispTimeStamp(Number(x[0].timestamp.toString()),epochAdjustment)
		);
	})
	*/
}

//トランザクション一覧
function parseTx(txs,parentId){
	for(var tx of txs){

		if([
			nem.TransactionType.AGGREGATE_COMPLETE,
			nem.TransactionType.AGGREGATE_BONDED
		].includes(tx.type)){

			const id = tx.transactionInfo.id;
			appendAggTx(tx);
			var tranType;
			if(alice.plain() ===  tx.signer.address.plain()){
 //			if(alice.plain() === tx.recipientAddress.plain()){
				tranType = "<font color='red'>送信[集約]</font>";
				txRepo.getTransactionEffectiveFee(tx.transactionInfo.hash)
 				.subscribe(fee => {
 					$("#amount"+ id)
 					.text(
 						dispAmount(nem.UInt64.fromNumericString(fee.toString()),6)
 					);
 				});
/*
				rxjs.zip(
 					txRepo.getTransactionEffectiveFee(tx.transactionInfo.hash),
 					rxjs.of({tx:tx})
 				).subscribe(x => {
 					$("#amount"+ x[1].tx.transactionInfo.id)
 					.text(
 						dispAmount(nem.UInt64.fromNumericString(x[0].toString()),6)
 					);
 				});
*/
 			}else{
				tranType = "<font color='green'>受信[集約]</font>";
 			}
 			$("#type"+ id ).html(tranType);

 			txRepo.getTransactionsById([tx.transactionInfo.hash],nem.TransactionGroup.Confirmed)
 			.subscribe(aggTx =>{
 				parseTx(aggTx[0].innerTransactions,id);
 			});

		}else if(tx.type === nem.TransactionType.TRANSFER){

//			xym = tx.mosaics.filter(item=> ["E74B99BA41F4AFEE",currencyId].includes(item.id.toHex()));
			xym = tx.mosaics.filter(item=> [currencyNamespaceId,currencyId].includes(item.id.toHex()));

			for(mosaic of xym){

				const id = tx.transactionInfo.id + mosaic.id.toHex();
				const mosaicAmount = mosaic.amount;
				if(parentId !== undefined){
					//インターナルトランザクション
					insertTxAfter("#agg" + parentId,id);
				}else{
					appendTx("#table",tx,id);
				}

				var tranType;
				if(alice.plain() ===  tx.signer.address.plain()){
					tranType = "<font color='red'>送信</font>";
					if(parentId === undefined){
						txRepo.getTransactionEffectiveFee(tx.transactionInfo.hash)
						.subscribe(fee => {

							$("#amount"+ id).text(
								dispAmount(
									mosaicAmount.add(
										nem.UInt64.fromNumericString(fee.toString())
									),6
								)
							);
						});
/*
						rxjs.zip(
							txRepo.getTransactionEffectiveFee(tx.transactionInfo.hash),
							rxjs.of({tx:tx,mosaic:mosaic})

						).subscribe(zip => {

							$("#amount"+ zip[1].tx.transactionInfo.id + zip[1].mosaic.id.toHex()).text(
								dispAmount(
									zip[1].mosaic.amount.add(
										nem.UInt64.fromNumericString(zip[0].toString())
									),6
								)
							);
						});
*/
					}else{
						$("#amount"+ id).text(dispAmount(mosaicAmount,6));
					}
				}else{
					tranType = "<font color='green'>受信</font>";
					$("#amount"+ id).text(dispAmount(mosaicAmount,6));
				}
				$("#type"+ id ).html(tranType);
			}
		}else{

			var tranType;

			const id = tx.transactionInfo.id;
			if(parentId !== undefined){
				//インターナルトランザクション
				insertTxAfter("#agg" + parentId,id);
			}else{
				appendTx("#table",tx,id);
			}

			if(alice.plain() ===  tx.signer.address.plain()){
				tranType = "<font color='red'>送信</font>";
				if(parentId === undefined){

					txRepo.getTransactionEffectiveFee(tx.transactionInfo.hash)
					.subscribe(fee => {

						$("#amount"+ id).text(
							dispAmount(
								nem.UInt64.fromNumericString(fee.toString())
								,6
							)
						);
					});

//					$("#amount"+ id).text(dispAmount(0,6));

				}else{

					$("#amount"+ id).text(dispAmount(0,6));
				}
			}else{
//				tranType = "<font color='green'>受信</font>";
//				$("#amount"+ id).text(dispAmount(0,6));
			}
			$("#type"+ id ).html(tranType);
		}
	}
}

function appendAggTx(tx){

	const id = tx.transactionInfo.id;
	$("#table").append("<tr id='agg" + id + "'>"
	+ "<td><a target='_blank' href='http://explorer.testnet.symboldev.network/transactions/"
	+ tx.transactionInfo.hash + "'><span id='date" + id + "'>"
	+ "</span></a></td>"
	+ "<td id='type" + id + "'></td>" //mosaicLabel
	+ "<td id='amount" + id + "' class='text-right'></td>"
	+ "</tr>"
	);

	blockRepo.getBlockByHeight(tx.transactionInfo.height)
	.subscribe(b => {

		$("#date"+ id).text(
			dispTimeStamp(Number(b.timestamp.toString()),epochAdjustment)
		);
	})

/*
	rxjs.zip(
		blockRepo.getBlockByHeight(tx.transactionInfo.height),
		rxjs.of({id:id})

	).subscribe(zip => {

		$("#date"+ zip[1].id).text(
			dispTimeStamp(Number(zip[0].timestamp.toString()),epochAdjustment)
		);
	})
*/
}

function appendTx(insTag,tx,id){

	$(insTag).append(
		"<tr>"
		+ "<td><a target='_blank' href='http://explorer.testnet.symboldev.network/transactions/"
		   + tx.transactionInfo.hash + "'><span id='date" + id + "'>"
		+ "</span></a></td>"
		+ "<td id='type" + id + "'></td>" //mosaicLabel
		+ "<td id='amount" + id + "' class='text-right'></td>"
		+ "</tr>"
	);


	blockRepo.getBlockByHeight(tx.transactionInfo.height)
	.subscribe(b => {

		$("#date"+ id).text(
			dispTimeStamp(Number(b.timestamp.toString()),epochAdjustment)
		);
	})

/*
	rxjs.zip(
		blockRepo.getBlockByHeight(tx.transactionInfo.height),
		rxjs.of({id:tx.transactionInfo.id + mosaic.id.toHex()})

	).subscribe(x => {

		$("#date"+ x[1].id).text(
			dispTimeStamp(Number(x[0].timestamp.toString()),epochAdjustment)
		);
	})
*/
}
function insertTxAfter(insTag,id){

	$(insTag).after(
		"<tr>"
		+ "<td></td>"
		+ "<td id='type" + id + "'></td>" //mosaicLabel
		+ "<td id='amount" + id + "'  class='text-right'></td>"
		+ "</tr>"
	);
}

function dispAmount(amount,divisibility){

	var strNum = amount.toString();
	if(divisibility > 0){

		if(amount < Math.pow(10, divisibility)){

			return "0." + paddingAmount0(strNum,0,divisibility);

		}else{

			var r = strNum.slice(-divisibility);
			var l = strNum.substring(0,strNum.length - divisibility);
			return comma3(l) + "." + r;
		}
	}else{
		return comma3(strNum);
	}
}
function comma3(strNum){
	return strNum.replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,');
}

function paddingAmount0(val,char,n){
	for(; val.length < n; val= char + val);
	return val;
}

function dispTimeStamp(timeStamp,epoch){

	var d = new Date(timeStamp + epoch * 1000)
	var strDate = d.getFullYear()%100
		+ "-" + paddingDate0( d.getMonth() + 1 )
		+ '-' + paddingDate0( d.getDate() )
		+ ' ' + paddingDate0( d.getHours() )
		+ ':' + paddingDate0( d.getMinutes() ) ;
	return 	strDate;
}

function paddingDate0(num) {
	return ( num < 10 ) ? '0' + num  : num;
};

$('#transfers_more').click(function(){getTransfers();return false;});
$('#harvests_more').click(function(){getHarvests();return false;});
$('#receipts_more').click(function(){getHarvests();return false;});
</script>
</body>
</html>
