<!doctype html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
	<link rel="apple-touch-icon" href="icon.png">
	<title>XEMBook</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
	<link rel="stylesheet" href="style.css" />
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-100421513-1', 'auto');
	ga('send', 'pageview');
	</script>
</head>
<body>
	<h1>XEMBook</h1>
	<hr class="zigzag-orange-white">
<div class="container">
	<div class="row">
	<div class="account col-sm-4">
	<h2>アカウント</h2>
	<dl id="account_info">
		<dt>アドレス</dt><dd><span id="account_address"></span></dd>
		<dt>残高</dt><dd><span id="account_balance"></span></dd>
		<dt>時価総額</dt><dd><span id="market_price"></span></dd>
		<dt>重要度</dt><dd><span id="account_importance"></span></dd>
	</dl>
	<h2>取引所</h2>
	<dl>
	<dt>Gate.io</dt><dd><span id="gateio"></span></dd>
	<dt>HBTC</dt><dd><span id="hbtc"></span></dd>
	<dt>ProBit</dt><dd><span id="probit"></span></dd>
	</dl>
	
	<h2>接続ノード</h2>
	<dl id="node_info">
		<dt>接続ノード</dt><dd><span id="node_host"></span></dd>
		<dt>最新ブロック</dt><dd><span id="chain_height"></span></dd>
		<dt>確定ブロック</dt><dd><span id="finalized_chain_height"></span></dd>
		<dt><a id="set_delegated_node" href="javascript:void(0)">委任ノード設定</a></dt><dd><span id="delegated_node"></span></dd>

	</dl>
	</div>
	<div class="account col-sm-4">
	<h2>レシート</h2>
	<dl>
	<dt>ターゲット</dt>
	<table id="harvest"  class="table">
		<thead><tr>
			<th>日時</th>
			<th>区分</th>
			<th>数量</th>
		</tr></thead>
	</table>
	<dd id="harvests_footer"><a id="harvests_more" href="javascript:void(0)" >さらに読み込む</a></dd>
	</dl>
	<dl>
	<dt>送信</dt>
	<table id="receipt"  class="table">
		<thead><tr>
			<th>日時</th>
			<th>区分</th>
			<th>数量</th>
		</tr></thead>
	</table>
	<dd id="receipts_footer"><a id="receipts_more" href="javascript:void(0)" >さらに読み込む</a></dd>
	</dl>
	</div>
	<div class="account col-sm-4">
	<h2>トランザクション</h2>
	<table id="table"  class="table">
		<thead><tr>
			<th>日時</th>
			<th>区分</th>
			<th>数量</th>
		</tr></thead>
	</table>
	<dd id="transfers_footer"><a id="transfers_more" href="javascript:void(0)" >さらに読み込む</a></dd>
	</div>
	</div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src="symbol-sdk-1.0.0.min.js"></script>
<script src="xembook.js"></script>
<script>


function appendAccountInfo(amount){

	$.when(
//			$.ajax({url: "https://blockchain.info/ticker?cors=true"         ,type: 'GET'}),
		$.ajax({url: "https://s3-ap-northeast-1.amazonaws.com/xembook.net/data/v2/tickers.json" ,type: 'GET',cache: false}),
	)
	.done(function(tickers) {
		console.log(tickers);
		
		probit = Math.round(tickers.USDJPY * tickers.probit * 1000) / 1000;
		gateio = Math.round(tickers.USDJPY * tickers.gateio * 1000) / 1000;
		hbtc = Math.round(tickers.USDJPY * tickers.hbtc * 1000) / 1000;
		$("#probit").text( probit + "円 / XYM");
		$("#gateio").text( gateio + "円 / XYM");
		$("#hbtc").text( hbtc + "円 / XYM");

		var market_price = amount / 1000000 * gateio;
		market_price = comma3(String(Math.round(market_price)));
		$("#market_price").text(market_price + "円 [" + gateio + "JPY/XYM換算]");
	});
}

function appendInfo(accountInfo){

	msigRepo.getMultisigAccountInfo(accountInfo.address)
	.subscribe(msig=>{
	
		//親キー
		for(cosignatory of msig.cosignatoryAddresses){
			console.log(cosignatory);
			parentAddress = cosignatory.pretty().slice(0,-25) + "..." + cosignatory.pretty().slice( -3 );
			$("#account_info").append('<dt>親キー</dt><dd><a href="?address=' + cosignatory.address + '">' + parentAddress + '</a></dd>');

		}	

		//子キー
		for(multisig of msig.multisigAddresses){
			console.log(multisig);
			childAddress = multisig.pretty().slice(0,-25) + "..."+ multisig.pretty().slice( -3 );;
			$("#account_info").append('<dt>子キー</dt><dd><a href="?address=' + multisig.address + '">' + childAddress + '</a></dd>');

		}	
		console.log()
	})


	chainRepo.getChainInfo().subscribe(x=>{

		rxjs.zip(
			blockRepo.getBlockByHeight(x.height),
			blockRepo.getBlockByHeight(x.latestFinalizedBlock.height),

		).subscribe(x => {

			$("#chain_height").html(
				"[ " + x[0].height.compact() + " ]　日時: " + dispTimeStamp(Number(x[0].timestamp.toString()),epochAdjustment)

			);
			$("#finalized_chain_height").html(
				"[ " + x[1].height.compact() + " ]　日時: " + dispTimeStamp(Number(x[1].timestamp.toString()),epochAdjustment)
			);

		})
	});
	nodeRepo.getNodeInfo().subscribe(x=>{
		$("#node_host").text(
			x.host
		);
	});


	var delegatedNode = localStorage.getItem('delegated_node' + address);
	var dnode ="https://" + delegatedNode;
//	if(delegatedNode !== "d3rmzi6ltfh1jy.cloudfront.net"){
	if(!NO_3001_NODES.includes(delegatedNode)){
		dnode = dnode + ":3001";
	}
	console.log(dnode)

	if(delegatedNode !== null){

		drepo = new nem.RepositoryFactoryHttp(dnode);
		dnodeRepo = drepo.createNodeRepository();

		dnodeRepo.getUnlockedAccount().subscribe(async x=>{
			console.log(x);

			harvesterKeys = Array();
			for(unlockedPublicKey of x){
				console.log(unlockedPublicKey);
				unlockedAddress = nem.PublicAccount.createFromPublicKey(unlockedPublicKey,networkType).address
				try{
					unlockedInfo = await accountRepo.getAccountInfo(unlockedAddress).toPromise();
					harvesterKeys.push(unlockedInfo.supplementalPublicKeys.linked.publicKey)
				}catch{
					console.log("no unlockedInfo:" + unlockedAddress.plain());
				}
			}

			var unlockedMark = "";
			if(harvesterKeys.includes(accountInfo.publicKey)){
				unlockedMark = "<font color='green'>●</font>"
			}else{
				unlockedMark = "<font color='red'>●</font>"
			}
			$("#delegated_node").html(
				unlockedMark + delegatedNode
			);
					
		},err=>{
			if (window.confirm("委任ノードが正しく設定されていません。設定をクリアしますか？\n設定：" + delegatedNode)) {
				console.log("removeItem:" + 'delegated_node' + address)
				localStorage.removeItem('delegated_node' + address)
			}
		});	
	}
}

function setDelegatedNode(){

	var delegatedNode = window.prompt('委任ノードを入力してください[HTTPSノードのみ]\n(例:ngl-dual-001.symbolblockchain.io)','');
	if(delegatedNode !== null){
		localStorage.setItem('delegated_node' + address,delegatedNode);
		alert("設定しました。次回表示時より、委任ノードの有効状態を確認します。")
	}
}


function appendAggTx(tx){

	const id = tx.transactionInfo.id;
	$("#table").append("<tr id='agg" + id + "'>"
	+ "<td><a target='_blank' href='http://explorer.symbolblockchain.io/transactions/"
	+ tx.transactionInfo.hash + "'><span id='date" + id + "'>"
	+ "</span></a></td>"
	+ "<td id='type" + id + "'></td>" //mosaicLabel
	+ "<td id='amount" + id + "' class='text-right'></td>"
	+ "</tr>"
	);

	blockRepo.getBlockByHeight(tx.transactionInfo.height)
	.subscribe(b => {

		$("#date"+ id).text(
			dispTimeStamp(Number(b.timestamp.toString()),epochAdjustment)
		);
	})
}

function appendTx(insTag,tx,id){

	$(insTag).append(
		"<tr>"
		+ "<td><a target='_blank' href='http://explorer.symbolblockchain.io/transactions/"
		   + tx.transactionInfo.hash + "'><span id='date" + id + "'>"
		+ "</span></a></td>"
		+ "<td id='type" + id + "'></td>" //mosaicLabel
		+ "<td id='amount" + id + "' class='text-right'></td>"
		+ "</tr>"
	);

	blockRepo.getBlockByHeight(tx.transactionInfo.height)
	.subscribe(b => {

		$("#date"+ id).text(
			dispTimeStamp(Number(b.timestamp.toString()),epochAdjustment)
		);
	})
}

function insertTxAfter(insTag,id){

	$(insTag).after(
		"<tr>"
		+ "<td></td>"
		+ "<td id='type" + id + "'></td>" //mosaicLabel
		+ "<td id='amount" + id + "'  class='text-right'></td>"
		+ "</tr>"
	);
}

$('#transfers_more').click(function(){getTransfers();return false;});
$('#harvests_more').click(function(){getHarvests();return false;});
$('#receipts_more').click(function(){getRecipets();return false;});
$('#set_delegated_node').click(function(){setDelegatedNode();return false;});
</script>
</body>
</html>
