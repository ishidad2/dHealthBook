<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
	<link rel="apple-touch-icon" href="icon.png">
	<title>XEMBook</title>
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
	<link rel="stylesheet" href="style.css" />
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	  ga('create', 'UA-100421513-1', 'auto');
	  ga('send', 'pageview');
	</script>
</head>
<body>

<div class="container">
	<h2>アカウント</h2>
	<dl id="account_info">
		<dt>口座名</dt><dd><span id="account_address"></span></dd>
		<dt>残高</dt><dd><span id="account_balance"></span></dd>
		<dt>重要度</dt><dd><span id="account_importance"></span></dd>
	</dl>

    <h2>送受信履歴:</h2>
    <table id="table"  class="table">
        <thead><tr>
            <th>日時</th>
			<th>区分</th>
            <th>モザイク</th>
            <th>数量</th>
            <th>メッセージ</th>
        </tr></thead>
    </table>
	<dd><a id="transfers_more" href="javascript:void(0)" >さらに読み込む</a></dd>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src="symbol-sdk-pack-0.21.0.js"></script>

<script>

//const NODE = 'https://sym-test.opening-line.jp:3001';
const NODE = 'https://d3rmzi6ltfh1jy.cloudfront.net';
const nem = require("/node_modules/symbol-sdk");
const op = require("/node_modules/rxjs/operators");
const rxjs = require("/node_modules/rxjs");


const nodeHttp = new nem.NodeHttp(NODE);
const accountHttp = new nem.AccountHttp(NODE);
const mosaicHttp = new nem.MosaicHttp(NODE);
const nsHttp = new nem.NamespaceHttp(NODE);
const receiptHttp = new nem.ReceiptHttp(NODE);
const txHttp = new nem.TransactionHttp(NODE);

const nsService = new nem.NamespaceService(nsHttp);

nodeHttp.getNodeInfo()
.subscribe(
x=>{
	console.log(x);
}

)

$('#transfers_more').click(function(){getTransfers(25);return false;});

//var address ="TBZ6G6M7Q2BA4H4LPG4FHBXNZHSZX6DCCR2XSYDG";
//var address ="TBFUPLVLQEZQZGOVIOBS6RPXOJCIDSMJYVNE4MQ";
var address ="TBQMNBY7Z3YTT2V7Y32CKSVQPJ3YDAD4RJ665AA";
//var address ="TB4BIZTP7VKFMF66MQPWEXQOS6HNDO7QH24XYLA";
//var address ="TA6IK6ZIPN5YD63NJADBKNDDLJYCZ5FJJ2B72DA";
var address ="TB5CCNP5W3WOEFJ34SWF3JPLDCS6OQQOA77LQYI";
var address ="TCBAUSZO3YIS2E3YW5KTSTIQ4VHCLYLL65DANCA";





	if (1 < document.location.search.length) {

		var query = document.location.search.substring(1);
		var prms = query.split('&');
		var item = new Object();
		for (var i = 0; i < prms.length; i++) {
			var elm   = prms[i].split('=');
			var idx   = decodeURIComponent(elm[0]);
			var val   = decodeURIComponent(elm[1]);
			item[idx] = decodeURIComponent(val);
		}
		address = item["address"];
	}

	if( address == ""){
	//		var proaddress = prompt_address();
		var proaddress = window.prompt('NEMアドレスを入力してください','');
		if(proaddress === ''){

		}else if(proaddress === null){
			alert("サンプル：XEMBookアカウントを表示します");
			address = "TBFUPLVLQEZQZGOVIOBS6RPXOJCIDSMJYVNE4MQ";
		}else{

			proaddress = proaddress.replace( /-/g , "" ).toUpperCase();
			location.href = "http://xembook.net/?address=" + proaddress;
		}
		address = address.replace( /-/g , "" ).toUpperCase();
		//history.replaceState(null,null,"/?address=" + address)

	}
	address = address.replace( /-/g , "" ).toUpperCase();

const alice = nem.Address.createFromRawAddress(address);
$("#account_address").text(alice.address);



//var mosaicInfos;	//モザイク情報格納用
//var mosaicNames;	//モザイク名格納用

var accountInfo = accountHttp.getAccountInfo(alice);
//アカウント情報
accountInfo
.pipe(
	op.mergeMap(_=>_.mosaics),
	op.filter(_ => _.id.toHex() === "5B66E76BECAD0860"),
)
.subscribe(_=>{
	$("#account_balance").append("<dd>" + dispAmount(_.amount.toString(),6) + "</dd>");
});

accountInfo.subscribe(_=>{
	$("#account_importance").append("<dd>" + _.importance.toString() + "</dd>");
});

//トランザクション取得
txHttp.search({address:alice,group:nem.TransactionGroup.Confirmed,embedded:true})
.subscribe(_=>{
	parseTx(_.data);
});

//receiptHttp.searchReceipts({targetAddress:alice,receiptTypes:nem.ReceiptType.Harvest_Fee})
receiptHttp.searchReceipts({targetAddress:alice})
.subscribe(_=>console.log(_.data))


//トランザクション一覧
function parseTx(_){

    for(var tx of _){
		console.log(tx)

		if(tx.type === nem.TransactionType.AGGREGATE_COMPLETE){ //16724
			 $("#table").append("<tr>"
			 + "<td><a target='_blank' href='http://explorer-0.10.0.x-01.symboldev.network/transactions/"
			 	+ tx.transactionInfo.hash + "''>"
				+ dispTimeStamp(parseInt(tx.transactionInfo.id.substring(0, 8), 16) * 1000)
			+ "</a></td>"
			 + "<td id='type" + tx.transactionInfo.id + "'></td>" //mosaicLabel
			 + "<td id='name" + tx.transactionInfo.id + "'></td>" //mosaicLabel
			 + "<td id='amount" + tx.transactionInfo.id + "'></td>"
			 + "<td id='message" + tx.transactionInfo.id + "'></td>"
			 + "</tr>"
			 );

		}else if(tx.type === nem.TransactionType.TRANSFER){

			xym = tx.mosaics.filter(item=>{
				console.log(item.id.toHex());
				if(item.id.constructor.name === "NamespaceId"){

					return "E74B99BA41F4AFEE" === item.id.toHex();//5B66E76BECAD0860

				}else{

					return "5B66E76BECAD0860" === item.id.toHex();//
				}
			});

			for(mosaic of xym){


				$("#table").append("<tr>"
				+ "<td><a target='_blank' href='http://explorer-0.10.0.x-01.symboldev.network/transactions/"
				   + tx.transactionInfo.hash + "''>"
				   + dispTimeStamp(parseInt(tx.transactionInfo.id.substring(0, 8), 16) * 1000)
				+ "</a></td>"
				+ "<td id='type" + tx.transactionInfo.id + mosaic.id.toHex() + "'></td>" //mosaicLabel
				+ "<td id='name" + tx.transactionInfo.id  + mosaic.id.toHex() + "'></td>" //mosaicLabel
				+ "<td id='amount" + tx.transactionInfo.id  + mosaic.id.toHex() + "'></td>"
				+ "<td id='message" + tx.transactionInfo.id + mosaic.id.toHex() + "'></td>"
				+ "</tr>"
				);

				var tranType;
				if(alice.plain() == tx.recipientAddress.plain()){
					tranType = "<font color='green'>受信</font>";
					$("#amount"+ tx.transactionInfo.id + mosaic.id.toHex()).text(dispAmount(mosaic.amount,6));
				}else{
					tranType = "<font color='red'>送信</font>";
					rxjs.zip(
						txHttp.getTransactionEffectiveFee(tx.transactionInfo.hash),
						rxjs.of({tx:tx,mosaic:mosaic})

					).subscribe(xx => {
						console.log(xx[1].tx.transactionInfo.id+ xx[1].mosaic.id.toHex());
						console.log(mosaic.amount);
						$("#amount"+ xx[1].tx.transactionInfo.id + xx[1].mosaic.id.toHex()).text(
							dispAmount(
								xx[1].mosaic.amount.add(
									nem.UInt64.fromNumericString(xx[0].toString())
								),6
							)
						);
					});

				}
				$("#type"+ tx.transactionInfo.id +mosaic.id.toHex() ).html(tranType);
				$("#name"+ tx.transactionInfo.id + mosaic.id.toHex()).text(tx.transactionInfo.id+ mosaic.id.toHex());

			}
		}

		if(tx.type == nem.TransactionType.TRANSFER){//16724

		}else if(tx.type == nem.TransactionType.AGGREGATE_COMPLETE ){//16705
			var tranType;
//			console.log(tx);
			if(alice.plain() == tx.signer.address.plain()){
				tranType = "<font color='red'>送信</font>";
				rxjs.zip(
					txHttp.getTransactionEffectiveFee(tx.transactionInfo.hash),
					rxjs.of([tx,mosaic])
				).subscribe(x => {
					$("#amount"+ x[1][0].transactionInfo.id)
					.text(
						dispAmount(	nem.UInt64.fromNumericString(x[0].toString()),6)
					);
				});
			}else{
				tranType = "<font color='green'>受信</font>";
			}
			$("#type"+ tx.transactionInfo.id ).html(tranType);
			$("#name"+ tx.transactionInfo.id).text("[アグリゲートトランザクション]");
			//console.log(tx)

			txHttp.getTransactionsById([tx.transactionInfo.hash],nem.TransactionGroup.Confirmed)
			.subscribe(__=>{
				console.log(__);
				parseTx(__[0].innerTransactions);
			});
//			parseTx(tx.innerTransactions,mosaicInfos,mosaicNames);
//			console.log(tx.transactionInfo.hash);
		}else{
			console.log(tx.type);
		}
	}
}

function dispAmount(amount,divisibility){

	var strNum = amount.toString();
	if(divisibility > 0){

		if(amount < Math.pow(10, divisibility)){

			return "0." + paddingAmount0(strNum,0,divisibility);

		}else{

			var r = strNum.slice(-divisibility);
			var l = strNum.substring(0,strNum.length - divisibility);
			return comma3(l) + "." + r;
		}

	}else{

		return comma3(strNum);
	}

}
function comma3(strNum){
	return strNum.replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,');
}

function paddingAmount0(val,char,n){
	for(; val.length < n; val= char + val);
	return val;
}

function dispTimeStamp(timeStamp){

	var d = new Date(timeStamp)
	var strDate = d.getFullYear()%100
		+ "-" + paddingDate0( d.getMonth() + 1 )
		+ '-' + paddingDate0( d.getDate() )
		+ ' ' + paddingDate0( d.getHours() )
		+ ':' + paddingDate0( d.getMinutes() ) ;
	return 	strDate;
}

function paddingDate0(num) {
	return ( num < 10 ) ? '0' + num  : num;
};


</script>
</body>
</html>
